services:
  # MySQL 数据库
  mysql:
    image: mysql:8.0
    container_name: springai-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root123}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-springai}
      MYSQL_USER: ${MYSQL_USER:-springai}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-springai123}
      TZ: Asia/Shanghai
    ports:
      - "3307:3306"
    volumes:
      - mysql-data:/var/lib/mysql
      - ./init-scripts:/docker-entrypoint-initdb.d
    networks:
      - springai-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      start_period: 30s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Redis 缓存和向量数据库
  redis:
    image: redis/redis-stack:latest
    container_name: springai-redis
    restart: unless-stopped
    command: ["redis-stack-server", "--requirepass", "${REDIS_PASSWORD:-redis123}"]
    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redis123}
      TZ: Asia/Shanghai
    ports:
      - "6380:6379"
    volumes:
      - redis-data:/data
    networks:
      - springai-network
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -a \"$${REDIS_PASSWORD}\" ping | grep -q PONG"]
      interval: 10s
      timeout: 5s
      start_period: 10s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # SpringAI MCP Server
  springai-mcp-server:
    build:
      context: ./springai-mcp-server
      dockerfile: Dockerfile
    container_name: springai-mcp-server
    restart: unless-stopped
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/${MYSQL_DATABASE:-springai}?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
      SPRING_DATASOURCE_USERNAME: ${MYSQL_USER:-springai}
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_PASSWORD:-springai123}
      TZ: Asia/Shanghai
    ports:
      - "8081:8081"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - springai-network
    healthcheck:
      test: ["CMD", "curl", "-s", "-o", "/dev/null", "http://localhost:8081/"]
      interval: 10s
      timeout: 5s
      start_period: 60s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Spring Boot 后端
  springai-backend:
    build:
      context: ./springai
      dockerfile: Dockerfile
    container_name: springai-backend
    restart: unless-stopped
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-prod}
      # 数据库配置
      DATASOURCE_URL: jdbc:mysql://mysql:3306/${MYSQL_DATABASE:-springai}?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true
      DATASOURCE_USERNAME: ${MYSQL_USER:-springai}
      DATASOURCE_PASSWORD: ${MYSQL_PASSWORD:-springai123}
      # Redis 配置
      DATA_REDIS_HOST: redis
      DATA_REDIS_PORT: 6379
      DATA_REDIS_PASSWORD: ${REDIS_PASSWORD:-redis123}
      # 容器内必须走服务名，不能使用 localhost
      MCP_SERVER_URL: ${MCP_SERVER_URL:-http://springai-mcp-server:8081}
      # AI 模型配置（环境变量名中 点→下划线、连字符→下划线，与 application.yaml 占位符路径一一对应）
      MODELARGS_MODELS_DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY}
      MODELARGS_MODELS_DEEPSEEK_BASE_URL: ${DEEPSEEK_BASE_URL:-https://api.deepseek.com}
      MODELARGS_MODELS_DEEPSEEK_NAME: ${DEEPSEEK_MODEL:-deepseek-chat}
      MODELARGS_MODELS_QWEN_API_KEY: ${QWEN_API_KEY}
      MODELARGS_MODELS_QWEN_NAME: ${QWEN_MODEL:-qwen-flash}
      MODELARGS_MODELS_ZHIPUAI_EMBED_API_KEY: ${ZHIPUAI_API_KEY}
      MODELARGS_MODELS_ZHIPUAI_EMBED_NAME: ${ZHIPUAI_EMBED_MODEL:-embedding-3}
      MODELARGS_MODELS_ZHIPUAI_EMBED_DIMENSIONS: ${ZHIPUAI_EMBED_DIMENSIONS:-1024}
      MODELARGS_MODELS_ZHIPUAI_EMBED_BASE_URL: ${ZHIPUAI_BASE_URL:-https://open.bigmodel.cn/api/paas}
      TZ: Asia/Shanghai
    ports:
      - "8080:8080"
    depends_on:
      springai-mcp-server:
        condition: service_healthy
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - springai-network
    healthcheck:
      test: ["CMD", "curl", "-s", "-o", "/dev/null", "http://localhost:8080/"]
      interval: 10s
      timeout: 5s
      start_period: 60s
      retries: 5
    volumes:
      - backend-logs:/app/logs
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Nginx（前端 + 反向代理）
  nginx:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: springai-nginx
    restart: unless-stopped
    ports:
      - "8085:80"
    depends_on:
      springai-backend:
        condition: service_healthy
    networks:
      - springai-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  springai-network:
    driver: bridge

volumes:
  mysql-data:
    driver: local
  redis-data:
    driver: local
  backend-logs:
    driver: local
